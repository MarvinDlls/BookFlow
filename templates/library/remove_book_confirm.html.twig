{% extends 'base.html.twig' %}

{% block title %}Confirmer la suppression{% endblock %}

{% block body %}
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h1 class="h4 mb-0">Confirmer la suppression</h1>
                    </div>
                    <div class="card-body">
                        <p>Êtes-vous sûr de vouloir retirer ce livre de l'étagère "{{ shelfName }}" ?</p>
                        
                        {% if book is defined %}
                            <div class="border p-3 mb-3">
                                <h5>{{ book.volumeInfo.title }}</h5>
                                {% if book.volumeInfo.authors is defined %}
                                    <p class="text-muted">
                                        {% for author in book.volumeInfo.authors %}
                                            {{ author }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </p>
                                {% endif %}
                                <small class="text-muted">ID: {{ book.id }}</small>
                            </div>
                        {% endif %}
                        
                        <form id="removeBookForm" action="{{ path('remove_book_from_shelf', {'userId': userId, 'shelfName': shelfName}) }}" method="post">
                            <input type="hidden" name="volumeId" value="{{ volumeId }}">
                            
                            <div class="d-flex justify-content-between">
                                <button type="submit" class="btn btn-danger">Confirmer la suppression</button>
                                <a href="{{ path('get_books_from_shelf', {'userId': userId, 'shelfName': shelfName}) }}" class="btn btn-outline-secondary">
                                    Annuler
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div id="responseMessage" class="alert mt-3 d-none"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('removeBookForm');
            const responseMessage = document.getElementById('responseMessage');
            
            // Soumission du formulaire avec AJAX
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    responseMessage.classList.remove('d-none', 'alert-success', 'alert-danger');
                    
                    if (data.success) {
                        responseMessage.classList.add('alert-success');
                        responseMessage.textContent = 'Le livre a été retiré avec succès!';
                        
                        // Redirection après 2 secondes
                        setTimeout(() => {
                            window.location.href = '{{ path('get_books_from_shelf', {'userId': userId, 'shelfName': shelfName}) }}';
                        }, 2000);
                    } else {
                        responseMessage.classList.add('alert-danger');
                        responseMessage.textContent = 'Erreur: ' + (data.error || 'Une erreur est survenue');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    responseMessage.classList.remove('d-none');
                    responseMessage.classList.add('alert-danger');
                    responseMessage.textContent = 'Une erreur est survenue lors de la suppression du livre';
                });
            });
        });
    </script>
{% endblock %}